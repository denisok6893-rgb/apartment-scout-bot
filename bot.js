const TelegramBot = require('node-telegram-bot-api');
const ApartmentParser = require('./parser.js');

const token = '8460225301:AAGa8wP1sm68NGl2AUDALVkQBYoFGdthrKo';
const bot = new TelegramBot(token, {polling: true});
const parser = new ApartmentParser();

// –•—Ä–∞–Ω–∏–ª–∏—â–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–∏—Å–∫–æ–≤
const activeSearches = new Map();

console.log('üè† –ë–æ—Ç –¥–ª—è –†–ï–ê–õ–¨–ù–û–ì–û –ø–æ–∏—Å–∫–∞ –∫–≤–∞—Ä—Ç–∏—Ä –∑–∞–ø—É—â–µ–Ω!');

// –ö–æ–º–∞–Ω–¥–∞ /start
bot.onText(/\/start/, (msg) => {
  const chatId = msg.chat.id;
  showMainMenu(chatId);
});

function showMainMenu(chatId) {
  const welcomeText = `
üè† *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–æ—Ç –†–ï–ê–õ–¨–ù–û–ì–û –ø–æ–∏—Å–∫–∞ –∫–≤–∞—Ä—Ç–∏—Ä!*

üîç *–ë–æ—Ç –∏—â–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è —Å:*
‚Ä¢ Avito
‚Ä¢ –¶–ò–ê–ù

üìç *–î–æ—Å—Ç—É–ø–Ω—ã–µ –≥–æ—Ä–æ–¥–∞:*
‚Ä¢ –°–∏–º—Ñ–µ—Ä–æ–ø–æ–ª—å
‚Ä¢ –ö—Ä—ã–º

üí° *–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç –ø–æ–∏—Å–∫–∞ –Ω–∏–∂–µ!*

‚ö†Ô∏è *–†–ï–ê–õ–¨–ù–´–ô –ø–æ–∏—Å–∫ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 10-20 —Å–µ–∫—É–Ω–¥*
  `;
  
  bot.sendMessage(chatId, welcomeText, {
    parse_mode: 'Markdown',
    reply_markup: {
      keyboard: [
        ['üîç –ü–æ–∏—Å–∫ –≤ –°–∏–º—Ñ–µ—Ä–æ–ø–æ–ª–µ', 'üè† –°–∏–º—Ñ–µ—Ä–æ–ø–æ–ª—å 1–∫'],
        ['üè† –°–∏–º—Ñ–µ—Ä–æ–ø–æ–ª—å 2–∫', 'üè† –°–∏–º—Ñ–µ—Ä–æ–ø–æ–ª—å 3–∫'],
        ['üåä –ö—Ä—ã–º', 'üõë –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∏—Å–∫'],
        ['üìû –ü–æ–º–æ—â—å']
      ],
      resize_keyboard: true
    }
  });
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–∏—Å–∫–∞
bot.onText(/üîç –ü–æ–∏—Å–∫|–ø–æ–∏—Å–∫|—Å–∏–º—Ñ–µ—Ä–æ–ø–æ–ª—å|–∫—Ä—ã–º|1–∫|2–∫|3–∫/i, async (msg) => {
  const chatId = msg.chat.id;
  const text = msg.text;
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –ø–æ–∏—Å–∫–∞
  let searchType = '–°–∏–º—Ñ–µ—Ä–æ–ø–æ–ª–µ';
  let roomType = '';
  
  if (text.includes('1–∫')) {
    searchType = '1-–∫–æ–º–Ω–∞—Ç–Ω—ã–µ –≤ –°–∏–º—Ñ–µ—Ä–æ–ø–æ–ª–µ';
    roomType = '1–∫';
  } else if (text.includes('2–∫')) {
    searchType = '2-–∫–æ–º–Ω–∞—Ç–Ω—ã–µ –≤ –°–∏–º—Ñ–µ—Ä–æ–ø–æ–ª–µ'; 
    roomType = '2–∫';
  } else if (text.includes('3–∫')) {
    searchType = '3-–∫–æ–º–Ω–∞—Ç–Ω—ã–µ –≤ –°–∏–º—Ñ–µ—Ä–æ–ø–æ–ª–µ';
    roomType = '3–∫';
  } else if (text.includes('–ö—Ä—ã–º')) {
    searchType = '–ö—Ä—ã–º';
  }
  
  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –ø–æ–∏—Å–∫–∞
  const searchMessage = await bot.sendMessage(chatId, 
    `üîç *–ó–∞–ø—É—Å–∫–∞–µ–º –†–ï–ê–õ–¨–ù–´–ô –ø–æ–∏—Å–∫ –≤ ${searchType}...*\n\n` +
    `‚è± *–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 10-20 —Å–µ–∫—É–Ω–¥*\n\n` +
    `_–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ ¬´üõë –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∏—Å–∫¬ª_`,
    {
      parse_mode: 'Markdown',
      reply_markup: {
        keyboard: [
          ['üõë –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∏—Å–∫']
        ],
        resize_keyboard: true
      }
    }
  );

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
  activeSearches.set(chatId, {
    messageId: searchMessage.message_id,
    startTime: Date.now()
  });

  try {
    // –í—ã–ø–æ–ª–Ω—è–µ–º –†–ï–ê–õ–¨–ù–´–ô –ø–æ–∏—Å–∫
    const apartments = await parser.searchApartments(searchType, roomType);
    
    // –£–¥–∞–ª—è–µ–º –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–∏—Å–∫–æ–≤
    activeSearches.delete(chatId);
    
    if (apartments.length > 0) {
      let response = `üè† *–ù–∞–π–¥–µ–Ω–æ ${apartments.length} –æ–±—ä—è–≤–ª–µ–Ω–∏–π –≤ ${searchType}:*\n\n`;
      
      apartments.forEach((apt, index) => {
        response += `*${index + 1}. ${apt.title}*\n`;
        response += `üí∞ *${apt.price}*\n`;
        response += `üìç ${apt.address}\n`;
        response += `üì± *${apt.source}*\n`;
        if (apt.link) {
          response += `üîó [–°–º–æ—Ç—Ä–µ—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ](${apt.link})\n`;
        }
        response += '\n' + '‚îÄ'.repeat(30) + '\n\n';
      });
      
      response += `‚úÖ *–ü–æ–∏—Å–∫ –∑–∞–≤–µ—Ä—à–µ–Ω!*\n_–î–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ_`;
      
      // –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      await bot.editMessageText(response, {
        chat_id: chatId,
        message_id: searchMessage.message_id,
        parse_mode: 'Markdown',
        disable_web_page_preview: true,
        reply_markup: {
          keyboard: [
            ['üîç –ü–æ–∏—Å–∫ –≤ –°–∏–º—Ñ–µ—Ä–æ–ø–æ–ª–µ', 'üè† –°–∏–º—Ñ–µ—Ä–æ–ø–æ–ª—å 1–∫'],
            ['üè† –°–∏–º—Ñ–µ—Ä–æ–ø–æ–ª—å 2–∫', 'üè† –°–∏–º—Ñ–µ—Ä–æ–ø–æ–ª—å 3–∫'],
            ['üåä –ö—Ä—ã–º', 'üìû –ü–æ–º–æ—â—å']
          ],
          resize_keyboard: true
        }
      });
      
    } else {
      await bot.editMessageText(
        `‚ùå *–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –≤ ${searchType}*\n\n` +
        `‚ö†Ô∏è *–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:*\n` +
        `‚Ä¢ –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–∞–π—Ç–∞–º–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–π\n` +
        `‚Ä¢ –ù–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π\n` +
        `‚Ä¢ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ\n\n` +
        `_–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞_`,
        {
          chat_id: chatId,
          message_id: searchMessage.message_id,
          parse_mode: 'Markdown',
          reply_markup: {
            keyboard: [
              ['üîç –ü–æ–∏—Å–∫ –≤ –°–∏–º—Ñ–µ—Ä–æ–ø–æ–ª–µ', 'üè† –°–∏–º—Ñ–µ—Ä–æ–ø–æ–ª—å 1–∫'],
              ['üè† –°–∏–º—Ñ–µ—Ä–æ–ø–æ–ª—å 2–∫', 'üè† –°–∏–º—Ñ–µ—Ä–æ–ø–æ–ª—å 3–∫'],
              ['üìû –ü–æ–º–æ—â—å']
            ],
            resize_keyboard: true
          }
        }
      );
    }
    
  } catch (error) {
    console.log('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
    
    // –£–¥–∞–ª—è–µ–º –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–∏—Å–∫–æ–≤
    activeSearches.delete(chatId);
    
    await bot.editMessageText(
      `‚ùå *–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ*\n\n` +
      `‚ö†Ô∏è *–ü–æ–ø—Ä–æ–±—É–π—Ç–µ:*\n` +
      `‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ\n` +
      `‚Ä¢ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–æ–∑–∂–µ\n` +
      `‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –ø–æ–∏—Å–∫–∞\n\n` +
      `_–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: ${error.message}_`,
      {
        chat_id: chatId,
        message_id: searchMessage.message_id,
        parse_mode: 'Markdown',
        reply_markup: {
          keyboard: [
            ['üîç –ü–æ–∏—Å–∫ –≤ –°–∏–º—Ñ–µ—Ä–æ–ø–æ–ª–µ', 'üè† –°–∏–º—Ñ–µ—Ä–æ–ø–æ–ª—å 1–∫'],
            ['üìû –ü–æ–º–æ—â—å']
          ],
          resize_keyboard: true
        }
      }
    );
  }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–æ–∏—Å–∫–∞
bot.onText(/üõë –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∏—Å–∫/, (msg) => {
  const chatId = msg.chat.id;
  
  if (activeSearches.has(chatId)) {
    activeSearches.delete(chatId);
    bot.sendMessage(chatId, 
      `‚èπ *–ü–æ–∏—Å–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!*\n\n` +
      `_–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞_`,
      {
        parse_mode: 'Markdown',
        reply_markup: {
          keyboard: [
            ['üîç –ü–æ–∏—Å–∫ –≤ –°–∏–º—Ñ–µ—Ä–æ–ø–æ–ª–µ', 'üè† –°–∏–º—Ñ–µ—Ä–æ–ø–æ–ª—å 1–∫'],
            ['üè† –°–∏–º—Ñ–µ—Ä–æ–ø–æ–ª—å 2–∫', 'üè† –°–∏–º—Ñ–µ—Ä–æ–ø–æ–ª—å 3–∫'],
            ['üìû –ü–æ–º–æ—â—å']
          ],
          resize_keyboard: true
        }
      }
    );
  } else {
    bot.sendMessage(chatId, '‚úÖ –°–µ–π—á–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏.');
  }
});

// –ö–æ–º–∞–Ω–¥–∞ /help
bot.onText(/\/help|üìû –ü–æ–º–æ—â—å/, (msg) => {
  const chatId = msg.chat.id;
  bot.sendMessage(chatId, 
    'üí° *–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º:*\n\n' +
    '1. –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç –ø–æ–∏—Å–∫–∞ –∏–∑ –∫–Ω–æ–ø–æ–∫\n' +
    '2. –ë–æ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç –†–ï–ê–õ–¨–ù–´–ô –ø–æ–∏—Å–∫ –Ω–∞ Avito –∏ –¶–ò–ê–ù\n' +
    '3. –î–æ–∂–¥–∏—Ç–µ—Å—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (10-20 —Å–µ–∫—É–Ω–¥)\n' +
    '4. –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ ¬´üõë –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∏—Å–∫¬ª\n\n' +
    '‚ö†Ô∏è *–†–ï–ê–õ–¨–ù–´–ô –ø–æ–∏—Å–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –Ω–∞—Å—Ç–æ—è—â–∏–º–∏ —Å–∞–π—Ç–∞–º–∏*\n\n' +
    'üè† *–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã:*\n' +
    '‚Ä¢ –ü–æ–∏—Å–∫ –≤ –°–∏–º—Ñ–µ—Ä–æ–ø–æ–ª–µ\n' +
    '‚Ä¢ 1, 2, 3-–∫–æ–º–Ω–∞—Ç–Ω—ã–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã\n' +
    '‚Ä¢ –ü–æ–∏—Å–∫ –ø–æ –ö—Ä—ã–º—É\n\n' +
    'üìû *–ü–æ–¥–¥–µ—Ä–∂–∫–∞:* @denisok6893',
    {parse_mode: 'Markdown'}
  );
});

console.log('‚úÖ –ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ –†–ï–ê–õ–¨–ù–û–ú–£ –ø–æ–∏—Å–∫—É!');
